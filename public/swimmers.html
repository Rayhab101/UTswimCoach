<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BL/SJ Swim Team- Swimmer Info</title>
    <link rel="stylesheet" href="swim.css" media="all">
    <script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous">
        </script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.debug.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous">
        </script>

    <script>
        $(function () {
            $("#header").load("heading.html");
            $("#footer").load("footing.html");
        });
    </script>
</head>

<style>
    .swim_info {
        padding-top: 95px;
    }

    table {
        background-color: rgba(255, 255, 255, .95);
        border-collapse: separate;
        border: solid black 1px;
        border-radius: 6px;
        -moz-border-radius: 6px;
        text-align: center;
        width: 100%
    }

    th {
        text-align: center;
        font-size: 24px;
    }
</style>

<body onload="tableLoad()">
    <header id="header"></header>
    <div class="swim_info" id="swim_info">
        <button onclick="window.history.go(-1)">Go Back</button>
        <button class="printPage" id="printPage"
            style="font-size: 12px; border-radius: 10%; background-color: white; font-weight: bold;"
            onclick="printImage()">Print Swimmer
            Data</button>
        <div class="container" id="container">
            <div id="testTable" printable>
                <table class="swimmer_data" id="swimmer_data">
                    <th id="swimmer_name"></th>
                </table>
            </div>
            <br>
            <br>
            <br>
            <div class="canvasContainer" id="canvasContainer">
                <canvas id="200fr" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="200IM" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="50fr" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="100fl" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="100fr" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="500fr" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="100bk" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
                <canvas id="100br" style="height: 300px; width: 100%; background-color: white;"></canvas><br>
            </div>
        </div>
    </div>
    <footer id="footer"></footer>
</body>
<script type="text/javascript">
    const schoolRecordM = ["1:56.66", "2:12:47", "1:01.52", "0:22.88", "0:58.99", "0:49.71", "5:36.41", "0:55.92", "1:04.94"];
    const schoolRecordF = ["2:10.79", "2:30.27", "1:14.39", "0:26.82", "1:12.17", "0:59.58", "5:57.35", "1:09.82", "1:16.54"];
    const stateRecordM = ["1:38.75", "1:51.74", "0:50.28", "0:20.60", "0:49.37", "0:45.39", "4:33.95", "0:49.49", "0:57.57"];
    const stateRecordF = ["1:51.33", "2:04.68", "0:58.30", "0:23.73", "0:54.61", "0:51.69", "5:02.94", "0:55.78", "1:04.02"];
    const meets = [new Date(2020, 09, 23),
    new Date(2020, 09, 30),
    new Date(2020, 11, 3),
    new Date(2020, 11, 15),
    new Date(2021, 0, 7),
    new Date(2021, 0, 12),
    new Date(2021, 0, 15),
    new Date(2021, 0, 21),
    new Date(2021, 0, 29),
    new Date(2021, 0, 30),
    new Date(2021, 1, 12)
    ];

    const events = ["200 Freestyle", "200 IM", "50 Freestyle", "100 Butterfly", "100 Freestyle", "500 Freestyle", "100 Backstroke", "100 Breaststroke"];

    function timesPull(id, column, cell, row, body) {
        var meet = cell.id.split("_")
        var pull = id + "&" + meet[1] + "&" + meet[0];
        fetch('/api/timeFill/' + pull)
            .then(function (response) {
                return response.json()
            })
            .then(function (races) {
                if (races.length != 0) {
                    var sending = races[0].time;
                    document.getElementById(cell.id).innerHTML = sending;
                }
            });
    }

    function maxPull(time) {
        if (time != "") {
            var check = time.split(".");
            var doubleCheck = check[0].split(":");
            var maybe = Number(doubleCheck[1]);
            maybe += 15;
            var minute = maybe > 59 ? Number(doubleCheck[0]) + 1 : doubleCheck[0];
            maybe = maybe > 59 ? maybe - 50 : maybe;
            var maxValue = minute + ":" + maybe + "." + check[1];
        }
        return maxValue;
    }

    function minPull(time) {
        if (time != "") {
            var check = time.split(".");
            var doubleCheck = check[0].split(":");
            var maybe = Number(doubleCheck[1]);
            maybe -= 5;
            var minute = maybe < 0 ? Number(doubleCheck[0]) - 1 : doubleCheck[0];
            maybe = maybe < 0 ? maybe + 50 : maybe;
            var minValue = minute + ":" + maybe + "." + check[1];
        }
        return minValue;
    }

    function getSwimData(tableData) {
        var name = tableData["name"];
        var headGrade = tableData["status_grade"];
        var body = document.getElementById("swimmer_data");
        var head = document.getElementById("swimmer_name");
        head.innerHTML = (name + " - " + headGrade);
        head.setAttribute("colspan", 9);
        body.appendChild(head);
        var meets = []
        fetch('/api/meets')
            .then(function (response) {
                return response.json();
            })
            .then(function (meet) {
                for (var i = 0; i < meet.length; i++) {
                    meets[i] = meet[i].location
                }
                var a = 1;
                for (var j = 0; j < meets.length; j++) {
                    var row = document.createElement("tr");
                    var column = document.createElement("td");
                    var cell = row.insertCell();
                    var text = document.createTextNode(column.innerHTML = meets[j]);
                    cell.appendChild(text);
                    if (j == 0) {
                        for (var i = 0; i < events.length; i++) {
                            cell = row.insertCell();
                            text = document.createTextNode(column.innerHTML = events[i]);
                            cell.appendChild(text);
                        }
                        body.appendChild(row);
                    }
                    else {
                        row = document.createElement("tr");
                        cell = row.insertCell();
                        cell.setAttribute("id", j);
                        cell.setAttribute("style", "width: 20%");
                        text = document.createTextNode(column.innerHTML = meets[j]);
                        cell.appendChild(text);
                        if (tableData["gender"] == "F") {
                            var to = 12
                            var from = 1
                        }
                        else {
                            var from = 12
                            var to = 22
                        }
                        for (var k = from; k < to; k++) {
                            var at = meet[a].meet_id
                            relays = [1, 8, 11, 12, 19, 22]
                            if (!relays.includes(k)) {
                                cell = row.insertCell();
                                cell.setAttribute("id", at + "_" + k)
                                timesPull(tableData.swimmer_id, column, cell, row, body)
                            }
                        }
                        body.appendChild(row);
                        a++;

                    }
                }
            })
            .catch(function (error) {
                console.log("Error: " + error);
            });
        //     var check = ['0:24.33','0:24.00'];
        // if(check[0]<check[1]){
        //     console.log(check[0]+" is less than "+ check[1]);
        // }
        // else{
        //     console.log(check[0]+" is not less than "+ check[1]);
        // }
    }

    function tableLoad() {
        var pullperson = location.search.substring(1);
        pullperson = pullperson.split("=");
        pullperson = Number(pullperson[1]);
        fetch("/api/swim/" + pullperson)
            .then(function (response) {
                return response.json();
            })
            .then(function (myJson) {
                getSwimData(myJson[0])

                fr200(myJson[0])
                im200(myJson[0])
                fr50(myJson[0])
                fl100(myJson[0])
                fr100(myJson[0])
                fr500(myJson[0])
                bk100(myJson[0])
                br100(myJson[0])
            })
            .catch(function (error) {
                console.log("Error: " + error);
            });
    }

    function getDate(id) {
        fetch('/api/meets/' + id)
            .then(function (response) {
                return response.json();
            })
            .then(function (fecha) {
                console.log(fecha[0].date)
            })
            .catch(function (error) {
                console.log("Error: " + error);
            });
    }

    function makeChart(race_id, pushDate, testChartData, schoolRecord, stateRecord, maxValue, title) {
        var minValue = minPull(stateRecord[0].y);
        var ctx = document.getElementById(race_id);
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: pushDate,
                datasets: [{
                    label: title + " Times",
                    data: testChartData,
                    fill: false,
                    pointBorderColor: 'rgba(0, 0, 0, 0.9)',
                    pointBackgroundColor: 'rgba(0, 0, 0, 0.5)',
                    borderColor: "rgba(0, 0, 0, 0.9)"
                },
                {
                    label: "School Record",
                    data: schoolRecord,
                    fill: true,
                    pointBorderColor: 'rgba(0, 0, 255, 0.9)',
                    pointBackgroundColor: 'rgba(0, 0, 255, 0.5)',
                    borderColor: "rgba(0, 0, 255, 0.9)"
                },
                {
                    label: "State Record",
                    data: stateRecord,
                    fill: true,
                    pointBorderColor: 'rgba(255, 0, 0, 0.9)',
                    pointBackgroundColor: 'rgba(255, 0, 0, 0.5)',
                    borderColor: "rgba(255, 0, 0, 0.9)"
                }
                ],

            },
            options: {
                scales: {
                    yAxes: [{
                        type: 'time',
                        time: {
                            parser: 'm:ss.SS',
                            unit: 'seconds',
                            unitStepSize: 10,
                            min: minValue,
                            max: maxValue,
                            displayFormats: {
                                'seconds': 'm:ss.SS'
                            }
                        },
                        ticks: { reverse: true }
                    }]
                },
            }
        });
        myChart.render();
    }

    var stuff = 0;
    async function lookForRace(id, event, race_id,school_id) {
        var race = ["200 Free", "200 IM", "50 Free", "100 Fly", "100 Free", "500 Free", "100 Backstroke", "100 Breaststroke"]
        var title = race[stuff]
        const meetInfo =  await fetch("/api/meets").then(data =>  data.json())
        const schoolRecord = await fetch("/api/schoolRecord/"+event +"&"+school_id).then(school => school.json())
        const stateRecord = await fetch("/api/races/"+event).then(state => state.json())
        fetch("/api/chartFill/" + id + "&" + event)
            .then(function (response) {
                return response.json()
            })
            .then(function(events) {
                var hide = document.getElementById(race_id);
                if (events.length != 0) {
                    var maxValue = maxPull(events[0].time)
                    var str=[]
                    var scr=[]
                    var j = 1
                    var newChartData = []
                    var testChartData = []
                    var dates = []

                    for (var i = 0; i < events.length; i++) {
                        newChartData[j] = events[i].time;
                        for(var k=0; k<meetInfo.length; k++){
                            if(events[i].meet==meetInfo[k].meet_id){
                                dates.push(meetInfo[k].date);
                                str[i] = {y:stateRecord[0].sr_time, x:dates,indexLabel:stateRecord[0].sr_time}
                                scr[i] = {y:schoolRecord[0].time, x:dates,indexLabel:schoolRecord[0].time}
                            }
                        }
                        testChartData[j-1] = { y: newChartData[j], x: dates[j-1], indexLabel: newChartData[j] };
                        j++;
                    }
                    makeChart(race_id, dates, testChartData, scr, str, maxValue, title);
                }
                else {
                    hide.setAttribute("style", "display:none");
                }
            })
            .catch(function (error) {
                console.log("Error: " + error);
            });
    }

    function fr200(chartData) {
        var races = chartData.gender == "F" ? 2 : 13;
        var race_id = "200fr";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function im200(chartData) {
        var races = chartData.gender == "F" ? 3 : 14;
        var race_id = "200IM";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function fr50(chartData) {
        var races = chartData.gender == "F" ? 4 : 15;
        var race_id = "50fr";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function fl100(chartData) {
        var races = chartData.gender == "F" ? 5 : 16;
        var race_id = "100fl";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function fr100(chartData) {
        var races = chartData.gender == "F" ? 6 : 17;
        var race_id = "100fr";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function fr500(chartData) {
        var races = chartData.gender == "F" ? 7 : 18;
        var race_id = "500fr";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function bk100(chartData) {
        var races = chartData.gender == "F" ? 9 : 20;
        var race_id = "100bk";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    function br100(chartData) {
        var races = chartData.gender == "F" ? 10 : 21;
        var race_id = "100br";
        lookForRace(chartData.swimmer_id, races, race_id,chartData.school)
        stuff++;
    }

    const races = ["200fr", "200IM", "50fr", "100fl", "100fr", "500fr", "100bk", "100br"];
    function printImage() {
        var table = document.getElementById("swimmer_data");
        console.log("HI")
        table.setAttribute("style", "font-size:12px");
        var windowContent = '<!DOCTYPE html>';
        windowContent += '<html>';
        windowContent += '<head><style> table {text-align: center; border: solid black 3px}tr,td {border: solid black 1px; text-align: center}th {text-align: center;}</style></head>';
        windowContent += '<body">';
        windowContent += table.outerHTML;
        //windowContent += '<br>'
        for (var i = 0; i < races.length; i++) {
            var dataUrl = document.getElementById(races[i]).toDataURL('image', 1.0);
            
            windowContent += '<img src="' + dataUrl + '" style="width:50%">';
        }
        windowContent += '</body>';
        windowContent += '</html>';
        const printWin = window.open('','_blank');
        
        printWin.document.open();
        printWin.document.write(windowContent);
        printWin.document.addEventListener('load', function () {
            printWin.focus();
            printWin.print();
            printWin.document.close();
            printWin.close();
        }, true);
        table.removeAttribute("style");
        //self.opener.location.reload();
        document.location.reload(true);
    }

    console.log(document.getElementById(races[2]).style.display=='none')
</script>

</html>